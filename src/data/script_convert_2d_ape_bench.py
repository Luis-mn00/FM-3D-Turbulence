# convert data from apebench (scraped or generated) to pbdl dataloader format
import numpy as np
import os
import json
import h5py
from utils import print_h5py
import math

data_dir = "/mnt/ssdraid/pbdl-datasets-local/2d_apebench_scraped_raw"
out_dir = "/mnt/ssdraid/pbdl-datasets-local/2d_apebench_scraped_new"

metadata = {
    "2d-diff-adv-test": {
        "PDE": "Advection",
        "Dimension": 2,
        "Fields Scheme": "d",
        "Fields": ["Density"],
        "Domain Extent": 1.0,
        "Resolution": [160, 160],
        "Time Steps": 201,
        "Dt": 0.1,
        "Boundary Conditions Order": ["x negative", "x positive", "y negative", "y positive"],
        "Boundary Conditions": ["periodic", "periodic", "periodic", "periodic"],
        "Difficulty": [0,-4,0,0,0],
        "Constants": [],
    },
    "2d-diff-adv-train": {
        "PDE": "Advection",
        "Dimension": 2,
        "Fields Scheme": "d",
        "Fields": ["Density"],
        "Domain Extent": 1.0,
        "Resolution": [160, 160],
        "Time Steps": 51,
        "Dt": 0.1,
        "Boundary Conditions Order": ["x negative", "x positive", "y negative", "y positive"],
        "Boundary Conditions": ["periodic", "periodic", "periodic", "periodic"],
        "Difficulty": [0,-4,0,0,0],
        "Constants": [],
    },
    "2d-diff-diff-test": {
        "PDE": "Diffusion",
        "Dimension": 2,
        "Fields Scheme": "d",
        "Fields": ["Density"],
        "Domain Extent": 1.0,
        "Resolution": [160, 160],
        "Time Steps": 201,
        "Dt": 0.1,
        "Boundary Conditions Order": ["x negative", "x positive", "y negative", "y positive"],
        "Boundary Conditions": ["periodic", "periodic", "periodic", "periodic"],
        "Difficulty": [0,0,4,0,0],
        "Constants": [],
    },
    "2d-diff-diff-train": {
        "PDE": "Diffusion",
        "Dimension": 2,
        "Fields Scheme": "d",
        "Fields": ["Density"],
        "Domain Extent": 1.0,
        "Resolution": [160, 160],
        "Time Steps": 51,
        "Dt": 0.1,
        "Boundary Conditions Order": ["x negative", "x positive", "y negative", "y positive"],
        "Boundary Conditions": ["periodic", "periodic", "periodic", "periodic"],
        "Difficulty": [0,0,4,0,0],
        "Constants": [],
    },
    "2d-diff-adv-diff-test": {
        "PDE": "Advection-Diffusion",
        "Dimension": 2,
        "Fields Scheme": "d",
        "Fields": ["Density"],
        "Domain Extent": 1.0,
        "Resolution": [160, 160],
        "Time Steps": 201,
        "Dt": 0.1,
        "Boundary Conditions Order": ["x negative", "x positive", "y negative", "y positive"],
        "Boundary Conditions": ["periodic", "periodic", "periodic", "periodic"],
        "Difficulty": [0,-4,4,0,0],
        "Constants": [],
    },
    "2d-diff-adv-diff-train": {
        "PDE": "Advection-Diffusion",
        "Dimension": 2,
        "Fields Scheme": "d",
        "Fields": ["Density"],
        "Domain Extent": 1.0,
        "Resolution": [160, 160],
        "Time Steps": 51,
        "Dt": 0.1,
        "Boundary Conditions Order": ["x negative", "x positive", "y negative", "y positive"],
        "Boundary Conditions": ["periodic", "periodic", "periodic", "periodic"],
        "Difficulty": [0,-4,4,0,0],
        "Constants": [],
    },
    "2d-diff-disp-test": {
        "PDE": "Dispersion",
        "Dimension": 2,
        "Fields Scheme": "d",
        "Fields": ["Density"],
        "Domain Extent": 1.0,
        "Resolution": [160, 160],
        "Time Steps": 201,
        "Dt": 0.1,
        "Boundary Conditions Order": ["x negative", "x positive", "y negative", "y positive"],
        "Boundary Conditions": ["periodic", "periodic", "periodic", "periodic"],
        "Difficulty": [0,0,0,4,0],
        "Constants": [],
    },
    "2d-diff-disp-train": {
        "PDE": "Dispersion",
        "Dimension": 2,
        "Fields Scheme": "d",
        "Fields": ["Density"],
        "Domain Extent": 1.0,
        "Resolution": [160, 160],
        "Time Steps": 51,
        "Dt": 0.1,
        "Boundary Conditions Order": ["x negative", "x positive", "y negative", "y positive"],
        "Boundary Conditions": ["periodic", "periodic", "periodic", "periodic"],
        "Difficulty": [0,0,0,4,0],
        "Constants": [],
    },
    "2d-diff-hyp-diff-test": {
        "PDE": "Hyper-Diffusion",
        "Dimension": 2,
        "Fields Scheme": "d",
        "Fields": ["Density"],
        "Domain Extent": 1.0,
        "Resolution": [160, 160],
        "Time Steps": 201,
        "Dt": 0.1,
        "Boundary Conditions Order": ["x negative", "x positive", "y negative", "y positive"],
        "Boundary Conditions": ["periodic", "periodic", "periodic", "periodic"],
        "Difficulty": [0,0,0,0,-4],
        "Constants": [],
    },
    "2d-diff-hyp-diff-train": {
        "PDE": "Hyper-Diffusion",
        "Dimension": 2,
        "Fields Scheme": "d",
        "Fields": ["Density"],
        "Domain Extent": 1.0,
        "Resolution": [160, 160],
        "Time Steps": 51,
        "Dt": 0.1,
        "Boundary Conditions Order": ["x negative", "x positive", "y negative", "y positive"],
        "Boundary Conditions": ["periodic", "periodic", "periodic", "periodic"],
        "Difficulty": [0,0,0,0,-4],
        "Constants": [],
    },
    "2d-phy-unbal-adv-test": {
        "PDE": "Advection",
        "Dimension": 2,
        "Fields Scheme": "d",
        "Fields": ["Density"],
        "Domain Extent": 1.0,
        "Resolution": [160, 160],
        "Time Steps": 201,
        "Dt": 0.1,
        "Boundary Conditions Order": ["x negative", "x positive", "y negative", "y positive"],
        "Boundary Conditions": ["periodic", "periodic", "periodic", "periodic"],
        "Velocity": [0.01, -0.04],
        "Constants": [],
    },
    "2d-phy-unbal-adv-train": {
        "PDE": "Advection",
        "Dimension": 2,
        "Fields Scheme": "d",
        "Fields": ["Density"],
        "Domain Extent": 1.0,
        "Resolution": [160, 160],
        "Time Steps": 51,
        "Dt": 0.1,
        "Boundary Conditions Order": ["x negative", "x positive", "y negative", "y positive"],
        "Boundary Conditions": ["periodic", "periodic", "periodic", "periodic"],
        "Velocity": [0.01, -0.04],
        "Constants": [],
    },
    "2d-phy-aniso-diff-test": {
        "PDE": "Diffusion",
        "Dimension": 2,
        "Fields Scheme": "d",
        "Fields": ["Density"],
        "Domain Extent": 1.0,
        "Resolution": [160, 160],
        "Time Steps": 201,
        "Dt": 0.1,
        "Boundary Conditions Order": ["x negative", "x positive", "y negative", "y positive"],
        "Boundary Conditions": ["periodic", "periodic", "periodic", "periodic"],
        "Viscosity": [[0.001, 0.0005],[0.0005, 0.002]],
        "Constants": [],
    },
    "2d-phy-aniso-diff-train": {
        "PDE": "Diffusion",
        "Dimension": 2,
        "Fields Scheme": "d",
        "Fields": ["Density"],
        "Domain Extent": 1.0,
        "Resolution": [160, 160],
        "Time Steps": 51,
        "Dt": 0.1,
        "Boundary Conditions Order": ["x negative", "x positive", "y negative", "y positive"],
        "Boundary Conditions": ["periodic", "periodic", "periodic", "periodic"],
        "Viscosity": [[0.001, 0.0005],[0.0005, 0.002]],
        "Constants": [],
    },
    "2d-phy-diag-diff-test": {
        "PDE": "Diffusion",
        "Dimension": 2,
        "Fields Scheme": "d",
        "Fields": ["Density"],
        "Domain Extent": 1.0,
        "Resolution": [160, 160],
        "Time Steps": 201,
        "Dt": 0.1,
        "Boundary Conditions Order": ["x negative", "x positive", "y negative", "y positive"],
        "Boundary Conditions": ["periodic", "periodic", "periodic", "periodic"],
        "Viscosity": [0.001, 0.002],
        "Constants": [],
    },
    "2d-phy-diag-diff-train": {
        "PDE": "Diffusion",
        "Dimension": 2,
        "Fields Scheme": "d",
        "Fields": ["Density"],
        "Domain Extent": 1.0,
        "Resolution": [160, 160],
        "Time Steps": 51,
        "Dt": 0.1,
        "Boundary Conditions Order": ["x negative", "x positive", "y negative", "y positive"],
        "Boundary Conditions": ["periodic", "periodic", "periodic", "periodic"],
        "Viscosity": [0.001, 0.002],
        "Constants": [],
    },
    "2d-phy-mix-disp-test": {
        "PDE": "Dispersion",
        "Dimension": 2,
        "Fields Scheme": "d",
        "Fields": ["Density"],
        "Domain Extent": 1.0,
        "Resolution": [160, 160],
        "Time Steps": 201,
        "Dt": 0.001,
        "Boundary Conditions Order": ["x negative", "x positive", "y negative", "y positive"],
        "Boundary Conditions": ["periodic", "periodic", "periodic", "periodic"],
        "Dispersivity": 0.00025,
        "Constants": [],
    },
    "2d-phy-mix-disp-train": {
        "PDE": "Dispersion",
        "Dimension": 2,
        "Fields Scheme": "d",
        "Fields": ["Density"],
        "Domain Extent": 1.0,
        "Resolution": [160, 160],
        "Time Steps": 51,
        "Dt": 0.001,
        "Boundary Conditions Order": ["x negative", "x positive", "y negative", "y positive"],
        "Boundary Conditions": ["periodic", "periodic", "periodic", "periodic"],
        "Dispersivity": 0.00025,
        "Constants": [],
    },
    "2d-phy-mix-hyp-test": {
        "PDE": "Hyper-Diffusion",
        "Dimension": 2,
        "Fields Scheme": "d",
        "Fields": ["Density"],
        "Domain Extent": 1.0,
        "Resolution": [160, 160],
        "Time Steps": 201,
        "Dt": 0.00001,
        "Boundary Conditions Order": ["x negative", "x positive", "y negative", "y positive"],
        "Boundary Conditions": ["periodic", "periodic", "periodic", "periodic"],
        "Hyper-Diffusivity": -0.000075,
        "Constants": [],
    },
    "2d-phy-mix-hyp-train": {
        "PDE": "Hyper-Diffusion",
        "Dimension": 2,
        "Fields Scheme": "d",
        "Fields": ["Density"],
        "Domain Extent": 1.0,
        "Resolution": [160, 160],
        "Time Steps": 51,
        "Dt": 0.00001,
        "Boundary Conditions Order": ["x negative", "x positive", "y negative", "y positive"],
        "Boundary Conditions": ["periodic", "periodic", "periodic", "periodic"],
        "Hyper-Diffusivity": -0.000075,
        "Constants": [],
    },

    "2d-diff-burgers-sc-test": {
        "PDE": "Burgers",
        "Dimension": 2,
        "Fields Scheme": "v",
        "Fields": ["Velocity"],
        "Domain Extent": 1.0,
        "Resolution": [160, 160],
        "Time Steps": 201,
        "Dt": 0.1,
        "Boundary Conditions Order": ["x negative", "x positive", "y negative", "y positive"],
        "Boundary Conditions": ["periodic", "periodic", "periodic", "periodic"],
        "Difficulty": [0,0,1.5,0,0],
        "Difficulty Convection": -1.5,
        "Constants": [],
    },
    "2d-diff-burgers-sc-train": {
        "PDE": "Burgers",
        "Dimension": 2,
        "Fields Scheme": "v",
        "Fields": ["Velocity"],
        "Domain Extent": 1.0,
        "Resolution": [160, 160],
        "Time Steps": 51,
        "Dt": 0.1,
        "Boundary Conditions Order": ["x negative", "x positive", "y negative", "y positive"],
        "Boundary Conditions": ["periodic", "periodic", "periodic", "periodic"],
        "Difficulty": [0,0,1.5,0,0],
        "Difficulty Convection": -1.5,
        "Constants": [],
    },
    "2d-diff-burgers-test": {
        "PDE": "Burgers",
        "Dimension": 2,
        "Fields Scheme": "VV",
        "Fields": ["Velocity X", "Velocity Y"],
        "Domain Extent": 1.0,
        "Resolution": [160, 160],
        "Time Steps": 201,
        "Dt": 0.1,
        "Boundary Conditions Order": ["x negative", "x positive", "y negative", "y positive"],
        "Boundary Conditions": ["periodic", "periodic", "periodic", "periodic"],
        "Difficulty": [0,0,1.5,0,0],
        "Difficulty Convection": -1.5,
        "Constants": [],
    },
    "2d-diff-burgers-train": {
        "PDE": "Burgers",
        "Dimension": 2,
        "Fields Scheme": "VV",
        "Fields": ["Velocity X", "Velocity Y"],
        "Domain Extent": 1.0,
        "Resolution": [160, 160],
        "Time Steps": 51,
        "Dt": 0.1,
        "Boundary Conditions Order": ["x negative", "x positive", "y negative", "y positive"],
        "Boundary Conditions": ["periodic", "periodic", "periodic", "periodic"],
        "Difficulty": [0,0,1.5,0,0],
        "Difficulty Convection": -1.5,
        "Constants": [],
    },
    "2d-diff-kdv-test": {
        "PDE": "Korteweg-de-Vries",
        "Dimension": 2,
        "Fields Scheme": "v",
        "Fields": ["Velocity"],
        "Domain Extent": 1.0,
        "Resolution": [160, 160],
        "Time Steps": 201,
        "Dt": 0.1,
        "Boundary Conditions Order": ["x negative", "x positive", "y negative", "y positive"],
        "Boundary Conditions": ["periodic", "periodic", "periodic", "periodic"],
        "Difficulty": [0,0,0,-14,-9],
        "Difficulty Convection": -2,
        "Constants": [],
    },
    "2d-diff-kdv-train": {
        "PDE": "Korteweg-de-Vries",
        "Dimension": 2,
        "Fields Scheme": "v",
        "Fields": ["Velocity"],
        "Domain Extent": 1.0,
        "Resolution": [160, 160],
        "Time Steps": 51,
        "Dt": 0.1,
        "Boundary Conditions Order": ["x negative", "x positive", "y negative", "y positive"],
        "Boundary Conditions": ["periodic", "periodic", "periodic", "periodic"],
        "Difficulty": [0,0,0,-14,-9],
        "Difficulty Convection": -2,
        "Constants": [],
    },
    "2d-diff-ks-test": {
        "PDE": "Kuramoto-Sivashinsky",
        "Dimension": 2,
        "Fields Scheme": "d",
        "Fields": ["Density"],
        "Domain Extent": 1.0,
        "Resolution": [160, 160],
        "Time Steps": 201,
        "Warmup Steps": 500,
        "Dt": 0.1,
        "Boundary Conditions Order": ["x negative", "x positive", "y negative", "y positive"],
        "Boundary Conditions": ["periodic", "periodic", "periodic", "periodic"],
        "Difficulty": [0,0,-1.2,0,-15],
        "Difficulty Gradient Norm": -6,
        "Constants": [],
    },
    "2d-diff-ks-train": {
        "PDE": "Kuramoto-Sivashinsky",
        "Dimension": 2,
        "Fields Scheme": "d",
        "Fields": ["Density"],
        "Domain Extent": 1.0,
        "Resolution": [160, 160],
        "Time Steps": 51,
        "Warmup Steps": 500,
        "Dt": 0.1,
        "Boundary Conditions Order": ["x negative", "x positive", "y negative", "y positive"],
        "Boundary Conditions": ["periodic", "periodic", "periodic", "periodic"],
        "Difficulty": [0,0,-1.2,0,-15],
        "Difficulty Gradient Norm": -6,
        "Constants": [],
    },

    "2d-diff-fisher-test": {
        "PDE": "Fisher-KPP",
        "Dimension": 2,
        "Fields Scheme": "c",
        "Fields": ["Concentration"],
        "Domain Extent": 1.0,
        "Resolution": [160, 160],
        "Time Steps": 201,
        "Dt": 0.1,
        "Boundary Conditions Order": ["x negative", "x positive", "y negative", "y positive"],
        "Boundary Conditions": ["periodic", "periodic", "periodic", "periodic"],
        "Difficulty": [0.02,0,0.2,0,0],
        "Difficulty Quadratic Polynomial": -0.02,
        "Constants": [],
    },
    "2d-diff-fisher-train": {
        "PDE": "Fisher-KPP",
        "Dimension": 2,
        "Fields Scheme": "c",
        "Fields": ["Concentration"],
        "Domain Extent": 1.0,
        "Resolution": [160, 160],
        "Time Steps": 51,
        "Dt": 0.1,
        "Boundary Conditions Order": ["x negative", "x positive", "y negative", "y positive"],
        "Boundary Conditions": ["periodic", "periodic", "periodic", "periodic"],
        "Difficulty": [0.02,0,0.2,0,0],
        "Difficulty Quadratic Polynomial": -0.02,
        "Constants": [],
    },
    "2d-phy-gs-theta-test": {
        "PDE": "Gray-Scott",
        "Dimension": 2,
        "Fields Scheme": "cb",
        "Fields": ["Concentration A", "Concentration B"],
        "Domain Extent": 2.5,
        "Resolution": [160, 160],
        "Time Steps": 201,
        "Dt": 20.0,
        "Boundary Conditions Order": ["x negative", "x positive", "y negative", "y positive"],
        "Boundary Conditions": ["periodic", "periodic", "periodic", "periodic"],
        "Sub Steps": 20,
        "Diffusivity A": 0.00002,
        "Diffusivity B": 0.00001,
        "Feed Rate": 0.040,
        "Kill Rate": 0.060,
        "Constants": [],
    },
    "2d-phy-gs-theta-train": {
        "PDE": "Gray-Scott",
        "Dimension": 2,
        "Fields Scheme": "cb",
        "Fields": ["Concentration A", "Concentration B"],
        "Domain Extent": 2.5,
        "Resolution": [160, 160],
        "Time Steps": 51,
        "Dt": 20.0,
        "Boundary Conditions Order": ["x negative", "x positive", "y negative", "y positive"],
        "Boundary Conditions": ["periodic", "periodic", "periodic", "periodic"],
        "Sub Steps": 20,
        "Diffusivity A": 0.00002,
        "Diffusivity B": 0.00001,
        "Feed Rate": 0.040,
        "Kill Rate": 0.060,
        "Constants": [],
    },
    "2d-phy-sh-test": {
        "PDE": "Swift-Hohenberg",
        "Dimension": 2,
        "Fields Scheme": "c",
        "Fields": ["Concentration"],
        "Domain Extent": 10.0 * math.pi,
        "Resolution": [160, 160],
        "Time Steps": 201,
        "Dt": 0.1,
        "Boundary Conditions Order": ["x negative", "x positive", "y negative", "y positive"],
        "Boundary Conditions": ["periodic", "periodic", "periodic", "periodic"],
        "Sub Steps": 5,
        "Reactivity": 0.7,
        "Critical Number": 1.0,
        "Constants": [],
    },
    "2d-phy-sh-train": {
        "PDE": "Swift-Hohenberg",
        "Dimension": 2,
        "Fields Scheme": "c",
        "Fields": ["Concentration"],
        "Domain Extent": 10.0 * math.pi,
        "Resolution": [160, 160],
        "Time Steps": 51,
        "Dt": 0.1,
        "Boundary Conditions Order": ["x negative", "x positive", "y negative", "y positive"],
        "Boundary Conditions": ["periodic", "periodic", "periodic", "periodic"],
        "Sub Steps": 5,
        "Reactivity": 0.7,
        "Critical Number": 1.0,
        "Constants": [],
    },

    "2d-phy-decay-turb-test": {
        "PDE": "Navier-Stokes: Decaying Turbulence",
        "Dimension": 2,
        "Fields Scheme": "v",
        "Fields": ["Vorticity"],
        "Domain Extent": 1.0,
        "Resolution": [160, 160],
        "Time Steps": 201,
        "Dt": 0.1,
        "Boundary Conditions Order": ["x negative", "x positive", "y negative", "y positive"],
        "Boundary Conditions": ["periodic", "periodic", "periodic", "periodic"],
        "Viscosity": 0.0001,
        "Constants": [],
    },
    "2d-phy-decay-turb-train": {
        "PDE": "Navier-Stokes: Decaying Turbulence",
        "Dimension": 2,
        "Fields Scheme": "v",
        "Fields": ["Vorticity"],
        "Domain Extent": 1.0,
        "Resolution": [160, 160],
        "Time Steps": 51,
        "Dt": 0.1,
        "Boundary Conditions Order": ["x negative", "x positive", "y negative", "y positive"],
        "Boundary Conditions": ["periodic", "periodic", "periodic", "periodic"],
        "Viscosity": 0.0001,
        "Constants": [],
    },
    "2d-phy-kolm-flow-test": {
        "PDE": "Navier-Stokes: Kolmogorov Flow",
        "Dimension": 2,
        "Fields Scheme": "v",
        "Fields": ["Vorticity"],
        "Domain Extent": 2*math.pi,
        "Resolution": [160, 160],
        "Time Steps": 201,
        "Warmup Steps": 500,
        "Dt": 0.1,
        "Boundary Conditions Order": ["x negative", "x positive", "y negative", "y positive"],
        "Boundary Conditions": ["periodic", "periodic", "periodic", "periodic"],
        "Sub Steps": 20,
        "Reynolds Number": 100,
        "Constants": [],
    },
    "2d-phy-kolm-flow-train": {
        "PDE": "Navier-Stokes: Kolmogorov Flow",
        "Dimension": 2,
        "Fields Scheme": "v",
        "Fields": ["Vorticity"],
        "Domain Extent": 2*math.pi,
        "Resolution": [160, 160],
        "Time Steps": 51,
        "Warmup Steps": 500,
        "Dt": 0.1,
        "Boundary Conditions Order": ["x negative", "x positive", "y negative", "y positive"],
        "Boundary Conditions": ["periodic", "periodic", "periodic", "periodic"],
        "Sub Steps": 20,
        "Reynolds Number": 100,
        "Constants": [],
    },
}

os.makedirs(out_dir, exist_ok=True)

for root, dirs, files in os.walk(data_dir):
    for file in sorted(files):
        if file.endswith(".npy"):
            data = np.load(os.path.join(root, file))
            name = os.path.splitext(file)[0]
            name = name.replace("_", "-")

            print(os.path.join(out_dir, name))
            print(data.shape)

            const = np.arange(data.shape[0]) # simulation seed is only constant
            const = const[:, np.newaxis]

            with h5py.File(os.path.join(out_dir, name + ".hdf5"), "w") as h5py_file:
                group = h5py_file.create_group("sims", track_order=True)
                for key in metadata[name]:
                    group.attrs[key] = metadata[name][key]
    
                for s in range(data.shape[0]):
                    dataset = h5py_file.create_dataset("sims/sim%d" % (s), data=data[s])
                    for m in range(len(metadata[name]["Constants"])):
                        key = metadata[name]["Constants"][m]
                        dataset.attrs[key] = const[s, m]
                h5py_file.close()

            print_h5py(os.path.join(out_dir, name + ".hdf5"))
            print("\n\n")
